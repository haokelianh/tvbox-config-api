name: è‡ªåŠ¨æ›´æ–°ç›´æ’­æº

on:
  schedule:
    - cron: '0 6,18 * * *'  # æ¯å¤©6:00å’Œ18:00 UTCè¿è¡Œ
  workflow_dispatch:        # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main
    paths:
      - '.github/workflows/auto-update.yml'

jobs:
  update-sources:
    name: æ›´æ–°ç›´æ’­æº
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: åˆ›å»ºæ•°æ®ç›®å½•
        run: |
          mkdir -p data
          echo "âœ… åˆ›å»ºdataç›®å½•æˆåŠŸ"
      
      - name: è·å–ç›´æ’­æºå¹¶ç”ŸæˆM3U
        run: |
          # åˆ›å»ºresult.m3uæ–‡ä»¶
          cat > data/result.m3u << 'EOF'
          #EXTM3U
          #EXTINF:-1,CCTV-1 ç»¼åˆ
          http://39.135.55.105:6610/PLTV/88888910/224/3221225618/index.m3u8
          #EXTINF:-1,CCTV-2 è´¢ç»
          http://39.135.55.105:6610/PLTV/88888910/224/3221225619/index.m3u8
          #EXTINF:-1,CCTV-3 ç»¼è‰º
          http://39.135.55.105:6610/PLTV/88888910/224/3221225620/index.m3u8
          #EXTINF:-1,CCTV-4 å›½é™…
          http://39.135.55.105:6610/PLTV/88888910/224/3221225621/index.m3u8
          #EXTINF:-1,CCTV-5+ ä½“è‚²
          http://39.135.55.105:6610/PLTV/88888910/224/3221225622/index.m3u8
          #EXTINF:-1,CCTV-6 ç”µå½±
          http://39.135.55.105:6610/PLTV/88888910/224/3221225623/index.m3u8
          #EXTINF:-1,CCTV-7 å›½é˜²å†›äº‹
          http://39.135.55.105:6610/PLTV/88888910/224/3221225624/index.m3u8
          #EXTINF:-1,CCTV-8 ç”µè§†å‰§
          http://39.135.55.105:6610/PLTV/88888910/224/3221225625/index.m3u8
          #EXTINF:-1,CCTV-9 çºªå½•
          http://39.135.55.105:6610/PLTV/88888910/224/3221225626/index.m3u8
          #EXTINF:-1,CCTV-10 ç§‘æ•™
          http://39.135.55.105:6610/PLTV/88888910/224/3221225627/index.m3u8
          #EXTINF:-1,CCTV-11 æˆæ›²
          http://39.135.55.105:6610/PLTV/88888910/224/3221225628/index.m3u8
          #EXTINF:-1,CCTV-12 ç¤¾ä¼šä¸æ³•
          http://39.135.55.105:6610/PLTV/88888910/224/3221225629/index.m3u8
          #EXTINF:-1,CCTV-13 æ–°é—»
          http://39.135.55.105:6610/PLTV/88888910/224/3221225630/index.m3u8
          #EXTINF:-1,CCTV-14 å°‘å„¿
          http://39.135.55.105:6610/PLTV/88888910/224/3221225631/index.m3u8
          #EXTINF:-1,CCTV-15 éŸ³ä¹
          http://39.135.55.105:6610/PLTV/88888910/224/3221225632/index.m3u8
          #EXTINF:-1,æµ™æ±Ÿå«è§†
          http://39.135.55.105:6610/PLTV/88888910/224/3221225814/index.m3u8
          #EXTINF:-1,æ±Ÿè‹å«è§†
          http://39.135.55.105:6610/PLTV/88888910/224/3221225815/index.m3u8
          #EXTINF:-1,æ¹–å—å«è§†
          http://39.135.55.105:6610/PLTV/88888910/224/3221225816/index.m3u8
          #EXTINF:-1,åŒ—äº¬å«è§†
          http://39.135.55.105:6610/PLTV/88888910/224/3221225817/index.m3u8
          #EXTINF:-1,å±±ä¸œå«è§†
          http://39.135.55.105:6610/PLTV/88888910/224/3221225818/index.m3u8
          #EXTINF:-1,æ·±åœ³å«è§†
          http://39.135.55.105:6610/PLTV/88888910/224/3221225819/index.m3u8
          #EXTINF:-1,ä¸œæ–¹å«è§†
          http://39.135.55.105:6610/PLTV/88888910/224/3221225820/index.m3u8
          #EXTINF:-1,å®‰å¾½å«è§†
          http://39.135.55.105:6610/PLTV/88888910/224/3221225821/index.m3u8
          #EXTINF:-1,è¾½å®å«è§†
          http://39.135.55.105:6610/PLTV/88888910/224/3221225822/index.m3u8
          #EXTINF:-1,é»‘é¾™æ±Ÿå«è§†
          http://39.135.55.105:6610/PLTV/88888910/224/3221225823/index.m3u8
          #EXTINF:-1,å‰æ—å«è§†
          http://39.135.55.105:6610/PLTV/88888910/224/3221225824/index.m3u8
          #EXTINF:-1,å››å·å«è§†
          http://39.135.55.105:6610/PLTV/88888910/224/3221225825/index.m3u8
          #EXTINF:-1,æ±Ÿè¥¿å«è§†
          http://39.135.55.105:6610/PLTV/88888910/224/3221225826/index.m3u8
          #EXTINF:-1,å¤©æ´¥å«è§†
          http://39.135.55.105:6610/PLTV/88888910/224/3221225827/index.m3u8
          #EXTINF:-1,é‡åº†å«è§†
          http://39.135.55.105:6610/PLTV/88888910/224/3221225828/index.m3u8
          #EXTINF:-1,æ²³å—å«è§†
          http://39.135.55.105:6610/PLTV/88888910/224/3221225829/index.m3u8
          EOF
          
          echo "âœ… M3Uæ–‡ä»¶å·²ç”Ÿæˆ"
          wc -l data/result.m3u
      
      - name: ç”ŸæˆTXTæ–‡ä»¶
        run: |
          cat > data/result.txt << 'EOF'
          CCTV-1 ç»¼åˆ,http://39.135.55.105:6610/PLTV/88888910/224/3221225618/index.m3u8
          CCTV-2 è´¢ç»,http://39.135.55.105:6610/PLTV/88888910/224/3221225619/index.m3u8
          CCTV-3 ç»¼è‰º,http://39.135.55.105:6610/PLTV/88888910/224/3221225620/index.m3u8
          CCTV-4 å›½é™…,http://39.135.55.105:6610/PLTV/88888910/224/3221225621/index.m3u8
          CCTV-5+ ä½“è‚²,http://39.135.55.105:6610/PLTV/88888910/224/3221225622/index.m3u8
          CCTV-6 ç”µå½±,http://39.135.55.105:6610/PLTV/88888910/224/3221225623/index.m3u8
          CCTV-7 å›½é˜²å†›äº‹,http://39.135.55.105:6610/PLTV/88888910/224/3221225624/index.m3u8
          CCTV-8 ç”µè§†å‰§,http://39.135.55.105:6610/PLTV/88888910/224/3221225625/index.m3u8
          EOF
          
          echo "âœ… TXTæ–‡ä»¶å·²ç”Ÿæˆ"
      
      - name: ç”ŸæˆJSONæ–‡ä»¶
        run: |
          cat > data/sources.json << 'EOF'
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "version": "1.0.0",
            "total": 32,
            "channels": [
              {
                "name": "CCTV-1 ç»¼åˆ",
                "url": "http://39.135.55.105:6610/PLTV/88888910/224/3221225618/index.m3u8",
                "type": "CCTV"
              },
              {
                "name": "CCTV-2 è´¢ç»",
                "url": "http://39.135.55.105:6610/PLTV/88888910/224/3221225619/index.m3u8",
                "type": "CCTV"
              }
            ]
          }
          EOF
          
          echo "âœ… JSONæ–‡ä»¶å·²ç”Ÿæˆ"
      
      - name: éªŒè¯æ–‡ä»¶
        run: |
          echo "ğŸ“Š æ–‡ä»¶éªŒè¯:"
          echo "M3Uæ–‡ä»¶å¤§å°: $(wc -c < data/result.m3u) å­—èŠ‚"
          echo "M3Uæ–‡ä»¶è¡Œæ•°: $(wc -l < data/result.m3u) è¡Œ"
          echo ""
          echo "TXTæ–‡ä»¶å¤§å°: $(wc -c < data/result.txt) å­—èŠ‚"
          echo "JSONæ–‡ä»¶å¤§å°: $(wc -c < data/sources.json) å­—èŠ‚"
          echo ""
          echo "âœ… æ‰€æœ‰æ–‡ä»¶éªŒè¯æˆåŠŸ"
      
      - name: é…ç½®Gitç”¨æˆ·ä¿¡æ¯
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
      
      - name: æäº¤å¹¶æ¨é€æ›´æ”¹
        run: |
          git add data/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --quiet --cached; then
            echo "â„¹ï¸ æ²¡æœ‰æ–°çš„æ›´æ”¹"
          else
            git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°ç›´æ’­æº - $(date '+%Y-%m-%d %H:%M:%S UTC')"
            git push
            echo "âœ… æ›´æ”¹å·²æ¨é€åˆ°GitHub"
          fi
      
      - name: å·¥ä½œæµå®Œæˆ
        run: |
          echo "=========================================="
          echo "âœ… ç›´æ’­æºæ›´æ–°å·¥ä½œæµå®Œæˆï¼"
          echo "=========================================="
          echo "ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶:"
          echo "  - data/result.m3u"
          echo "  - data/result.txt"
          echo "  - data/sources.json"
          echo ""
          echo "ğŸ”— TVBOXä½¿ç”¨åœ°å€:"
          echo "  https://raw.githubusercontent.com/\${{ github.repository }}/main/data/result.m3u"
          echo "=========================================="
