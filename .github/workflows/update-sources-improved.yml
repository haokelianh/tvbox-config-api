name: è‡ªåŠ¨æ›´æ–°ç›´æ’­æº

on:
  schedule:
    - cron: '0 6,18 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/update-sources.yml'

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: åˆ›å»ºdataç›®å½•
        run: |
          mkdir -p data
          echo "âœ… ç›®å½•å·²åˆ›å»º"
      
      - name: ç”ŸæˆM3Uæ–‡ä»¶
        run: |
          cat > data/result.m3u << 'MEOF'
          #EXTM3U
          #EXTINF:-1,CCTV-1 ç»¼åˆ
          http://example.com/cctv1.m3u8
          #EXTINF:-1,CCTV-2 è´¢ç»
          http://example.com/cctv2.m3u8
          #EXTINF:-1,CCTV-3 ç»¼è‰º
          http://example.com/cctv3.m3u8
          #EXTINF:-1,CCTV-4 å›½é™…
          http://example.com/cctv4.m3u8
          #EXTINF:-1,CCTV-5+ ä½“è‚²
          http://example.com/cctv5.m3u8
          #EXTINF:-1,CCTV-6 ç”µå½±
          http://example.com/cctv6.m3u8
          #EXTINF:-1,CCTV-7 å›½é˜²å†›äº‹
          http://example.com/cctv7.m3u8
          #EXTINF:-1,CCTV-8 ç”µè§†å‰§
          http://example.com/cctv8.m3u8
          #EXTINF:-1,CCTV-9 çºªå½•
          http://example.com/cctv9.m3u8
          #EXTINF:-1,CCTV-10 ç§‘æ•™
          http://example.com/cctv10.m3u8
          #EXTINF:-1,CCTV-11 æˆæ›²
          http://example.com/cctv11.m3u8
          #EXTINF:-1,CCTV-12 ç¤¾ä¼šä¸æ³•
          http://example.com/cctv12.m3u8
          #EXTINF:-1,CCTV-13 æ–°é—»
          http://example.com/cctv13.m3u8
          #EXTINF:-1,CCTV-14 å°‘å„¿
          http://example.com/cctv14.m3u8
          #EXTINF:-1,CCTV-15 éŸ³ä¹
          http://example.com/cctv15.m3u8
          MEOF
          echo "âœ… M3Uæ–‡ä»¶å·²ç”Ÿæˆ"
          wc -l data/result.m3u
      
      - name: ç”ŸæˆTXTæ–‡ä»¶
        run: |
          cat > data/result.txt << 'TEOF'
          CCTV-1 ç»¼åˆ,http://example.com/cctv1.m3u8
          CCTV-2 è´¢ç»,http://example.com/cctv2.m3u8
          CCTV-3 ç»¼è‰º,http://example.com/cctv3.m3u8
          CCTV-4 å›½é™…,http://example.com/cctv4.m3u8
          CCTV-5+ ä½“è‚²,http://example.com/cctv5.m3u8
          CCTV-6 ç”µå½±,http://example.com/cctv6.m3u8
          CCTV-7 å›½é˜²å†›äº‹,http://example.com/cctv7.m3u8
          CCTV-8 ç”µè§†å‰§,http://example.com/cctv8.m3u8
          CCTV-9 çºªå½•,http://example.com/cctv9.m3u8
          CCTV-10 ç§‘æ•™,http://example.com/cctv10.m3u8
          CCTV-11 æˆæ›²,http://example.com/cctv11.m3u8
          CCTV-12 ç¤¾ä¼šä¸æ³•,http://example.com/cctv12.m3u8
          CCTV-13 æ–°é—»,http://example.com/cctv13.m3u8
          CCTV-14 å°‘å„¿,http://example.com/cctv14.m3u8
          CCTV-15 éŸ³ä¹,http://example.com/cctv15.m3u8
          TEOF
          echo "âœ… TXTæ–‡ä»¶å·²ç”Ÿæˆ"
          wc -l data/result.txt
      
      - name: ç”ŸæˆJSONæ–‡ä»¶
        run: |
          cat > data/sources.json << 'JEOF'
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "channels": [
              {"name": "CCTV-1 ç»¼åˆ", "url": "http://example.com/cctv1.m3u8"},
              {"name": "CCTV-2 è´¢ç»", "url": "http://example.com/cctv2.m3u8"},
              {"name": "CCTV-3 ç»¼è‰º", "url": "http://example.com/cctv3.m3u8"},
              {"name": "CCTV-4 å›½é™…", "url": "http://example.com/cctv4.m3u8"},
              {"name": "CCTV-5+ ä½“è‚²", "url": "http://example.com/cctv5.m3u8"},
              {"name": "CCTV-6 ç”µå½±", "url": "http://example.com/cctv6.m3u8"},
              {"name": "CCTV-7 å›½é˜²å†›äº‹", "url": "http://example.com/cctv7.m3u8"},
              {"name": "CCTV-8 ç”µè§†å‰§", "url": "http://example.com/cctv8.m3u8"}
            ]
          }
          JEOF
          echo "âœ… JSONæ–‡ä»¶å·²ç”Ÿæˆ"
      
      - name: æ£€æŸ¥æ–‡ä»¶
        run: |
          echo "ğŸ“ æ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -lh data/
          echo ""
          echo "ğŸ“ M3Uæ–‡ä»¶å†…å®¹ï¼ˆå‰5è¡Œï¼‰ï¼š"
          head -5 data/result.m3u
      
      - name: é…ç½®Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
      
      - name: æäº¤å˜æ›´
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git add data/
            git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°ç›´æ’­æº - $(date '+%Y-%m-%d %H:%M:%S')"
            git push
            echo "âœ… æ¨é€æˆåŠŸ"
          else
            echo "â„¹ï¸ æ²¡æœ‰æ–°çš„æ›´æ”¹"
          fi
      
      - name: éªŒè¯æ–‡ä»¶
        run: |
          echo "âœ… å·¥ä½œæµå®Œæˆï¼"
          echo "ğŸ“Š æ–‡ä»¶ç»Ÿè®¡ï¼š"
          echo "  M3Uæ–‡ä»¶: $(wc -l < data/result.m3u) è¡Œ"
          echo "  TXTæ–‡ä»¶: $(wc -l < data/result.txt) è¡Œ"
          echo "ğŸ“„ æ–‡ä»¶å·²ä¿å­˜åœ¨ data/ ç›®å½•"
